# Kafka Event Schemas: Phase V Advanced Cloud Deployment

**Generated**: 2025-12-29 | **Plan**: [plan.md](../plan.md)

## Overview

This document defines the Kafka event schemas for the event-driven architecture. All events are published via Dapr Pub/Sub to Kafka topics.

---

## Event Envelope

All events follow a common envelope structure:

```json
{
  "event_id": "uuid-v4",
  "event_type": "task.created",
  "timestamp": "2025-12-29T10:00:00Z",
  "correlation_id": "uuid-v4",
  "user_id": 1,
  "data": {}
}
```

### Envelope Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `event_id` | string (UUID) | Yes | Unique identifier for this event |
| `event_type` | string | Yes | Event type from the type system below |
| `timestamp` | string (ISO 8601) | Yes | Event creation timestamp in UTC |
| `correlation_id` | string (UUID) | Yes | For request tracing across services |
| `user_id` | integer | Yes | User who triggered the event (always 1 for single-user demo) |
| `data` | object | Yes | Event-specific payload |

---

## Task Events (topic: `task-events`)

### Event Types

| Event Type | Description | Publisher |
|------------|-------------|-----------|
| `task.created` | New task created | Backend API |
| `task.updated` | Task details modified | Backend API |
| `task.completed` | Task marked as completed | Backend API |
| `task.deleted` | Task deleted | Backend API |

### task.created

```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "event_type": "task.created",
  "timestamp": "2025-12-29T10:00:00Z",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440001",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "task": {
      "title": "Weekly team meeting",
      "description": "Discuss project updates",
      "due_date": "2025-12-30T09:00:00Z",
      "recurrence": "weekly",
      "priority": "high",
      "tags": ["work", "meeting"],
      "status": "pending",
      "parent_task_id": null,
      "reminder_offset": "1 day"
    }
  }
}
```

### task.updated

```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440002",
  "event_type": "task.updated",
  "timestamp": "2025-12-29T10:30:00Z",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "changes": {
      "priority": "medium",
      "due_date": "2025-12-31T09:00:00Z"
    },
    "task": {
      "id": 123,
      "title": "Weekly team meeting",
      "description": "Discuss project updates",
      "due_date": "2025-12-31T09:00:00Z",
      "recurrence": "weekly",
      "priority": "medium",
      "tags": ["work", "meeting"],
      "status": "pending"
    }
  }
}
```

### task.completed

```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440004",
  "event_type": "task.completed",
  "timestamp": "2025-12-29T10:00:00Z",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440005",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "task": {
      "id": 123,
      "title": "Weekly team meeting",
      "description": "Discuss project updates",
      "due_date": "2025-12-29T09:00:00Z",
      "recurrence": "weekly",
      "priority": "high",
      "tags": ["work", "meeting"],
      "status": "completed",
      "completed_at": "2025-12-29T10:00:00Z",
      "parent_task_id": null
    },
    "next_occurrence": null
  }
}
```

### task.deleted

```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440006",
  "event_type": "task.deleted",
  "timestamp": "2025-12-29T11:00:00Z",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440007",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "cancelled_reminder_id": 45,
    "affected_occurrences": [124, 125, 126]
  }
}
```

---

## Reminder Events (topic: `reminders`)

### Event Types

| Event Type | Description | Publisher |
|------------|-------------|-----------|
| `reminder.scheduled` | New reminder created | Backend API |
| `reminder.triggered` | Dapr Jobs callback fired | Notification Service |
| `reminder.sent` | Notification delivered | Notification Service |
| `reminder.failed` | All retry attempts exhausted | Notification Service |
| `reminder.cancelled` | Reminder cancelled by user | Backend API |

### reminder.scheduled

```json
{
  "event_id": "660e8400-e29b-41d4-a716-446655440000",
  "event_type": "reminder.scheduled",
  "timestamp": "2025-12-29T10:00:00Z",
  "correlation_id": "660e8400-e29b-41d4-a716-446655440001",
  "user_id": 1,
  "data": {
    "reminder_id": 45,
    "task_id": 123,
    "task_title": "Weekly team meeting",
    "scheduled_at": "2025-12-30T08:00:00Z",
    "reminder_type": "websocket",
    "dapr_job_id": "reminder-45-2025-12-30T08:00:00Z",
    "reminder_offset": "1 day"
  }
}
```

### reminder.triggered

```json
{
  "event_id": "660e8400-e29b-41d4-a716-446655440002",
  "event_type": "reminder.triggered",
  "timestamp": "2025-12-30T08:00:00Z",
  "correlation_id": "660e8400-e29b-41d4-a716-446655440003",
  "user_id": 1,
  "data": {
    "reminder_id": 45,
    "task_id": 123,
    "task_title": "Weekly team meeting",
    "due_date": "2025-12-30T09:00:00Z",
    "scheduled_at": "2025-12-30T08:00:00Z",
    "dapr_job_id": "reminder-45-2025-12-30T08:00:00Z"
  }
}
```

### reminder.sent

```json
{
  "event_id": "660e8400-e29b-41d4-a716-446655440004",
  "event_type": "reminder.sent",
  "timestamp": "2025-12-30T08:00:01Z",
  "correlation_id": "660e8400-e29b-41d4-a716-446655440005",
  "user_id": 1,
  "data": {
    "reminder_id": 45,
    "task_id": 123,
    "delivery_method": "websocket",
    "delivery_time_ms": 150
  }
}
```

### reminder.failed

```json
{
  "event_id": "660e8400-e29b-41d4-a716-446655440006",
  "event_type": "reminder.failed",
  "timestamp": "2025-12-30T08:05:00Z",
  "correlation_id": "660e8400-e29b-41d4-a716-446655440007",
  "user_id": 1,
  "data": {
    "reminder_id": 45,
    "task_id": 123,
    "error": "WebSocket connection failed after 3 retries",
    "retry_count": 3,
    "last_attempt": "2025-12-30T08:05:00Z"
  }
}
```

### reminder.cancelled

```json
{
  "event_id": "660e8400-e29b-41d4-a716-446655440008",
  "event_type": "reminder.cancelled",
  "timestamp": "2025-12-30T07:00:00Z",
  "correlation_id": "660e8400-e29b-41d4-a716-446655440009",
  "user_id": 1,
  "data": {
    "reminder_id": 45,
    "task_id": 123,
    "dapr_job_deleted": true,
    "reason": "Task completed early"
  }
}
```

---

## Task Updates Events (topic: `task-updates`)

### Event Types

| Event Type | Description | Publisher |
|------------|-------------|-----------|
| `update.priority_changed` | Task priority modified | Backend API |
| `update.tags_added` | Tags added to task | Backend API |
| `update.tags_removed` | Tags removed from task | Backend API |
| `update.due_date_changed` | Due date modified | Backend API |

### update.priority_changed

```json
{
  "event_id": "770e8400-e29b-41d4-a716-446655440000",
  "event_type": "update.priority_changed",
  "timestamp": "2025-12-29T10:30:00Z",
  "correlation_id": "770e8400-e29b-41d4-a716-446655440001",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "old_priority": "low",
    "new_priority": "high",
    "task_title": "Weekly team meeting"
  }
}
```

### update.tags_added

```json
{
  "event_id": "770e8400-e29b-41d4-a716-446655440002",
  "event_type": "update.tags_added",
  "timestamp": "2025-12-29T11:00:00Z",
  "correlation_id": "770e8400-e29b-41d4-a716-446655440003",
  "user_id": 1,
  "data": {
    "task_id": 123,
    "tags_added": ["urgent"],
    "all_tags": ["work", "meeting", "urgent"]
  }
}
```

---

## Dapr Job Callback Events

Internal events used for Dapr Jobs API callback processing:

```json
{
  "event_id": "880e8400-e29b-41d4-a716-446655440000",
  "event_type": "dapr.job.callback",
  "timestamp": "2025-12-30T08:00:00Z",
  "correlation_id": "880e8400-e29b-41d4-a716-446655440001",
  "user_id": 1,
  "data": {
    "job_id": "reminder-45-2025-12-30T08:00:00Z",
    "job_type": "reminder",
    "callback_data": {
      "reminder_id": 45,
      "task_id": 123,
      "user_id": 1,
      "type": "reminder"
    }
  }
}
```

---

## Consumer Groups

| Topic | Consumer Group | Consumer Services |
|-------|----------------|-------------------|
| `task-events` | taskflow-consumer-group | Recurring Task Service, Audit Service |
| `reminders` | taskflow-consumer-group | Notification Service |
| `task-updates` | taskflow-consumer-group | Frontend (via WebSocket) |

---

## Partition Key Strategy

Events are partitioned by `user_id` to ensure ordering per user:

```python
partition_key = str(event["user_id"])  # "1" for single-user demo
```

This ensures all events for a user go to the same partition, maintaining order.

---

## Schema Evolution

### Backward Compatibility Rules

1. **Adding fields**: New fields must be optional (have default values)
2. **Removing fields**: Fields are never removed, deprecated instead
3. **Changing field types**: Not allowed (use a new field name)
4. **Enum values**: New enum values are added, existing values never removed

### Versioning

Events include an implicit version based on the schema location:
- Current version: `2025-12-29-v1`
- Schema registry: `contracts/events.yaml`

---

## Validation

All events should be validated before publishing:

```python
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime
import uuid

class EventEnvelope(BaseModel):
    event_id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    event_type: str
    timestamp: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    correlation_id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    user_id: int = 1
    data: dict
```

---

## References

- [Dapr Pub/Sub Component](https://docs.dapr.io/reference/components-reference/supported-pubsub/)
- [Kafka Event Schema Best Practices](https://docs.confluent.io/platform/current/schema-registry/index.html)
- [AWS EventBridge Schema Registry](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-schema-registry.html)
